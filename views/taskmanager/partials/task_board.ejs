<!-- views/taskmanager/partials/task_board.ejs -->

<% const priority_colors = { low: 'ðŸŸ¢', medium: 'ðŸŸ¡', high: 'ðŸ”´', }; %> <% const
now = new Date(); const oneDay = 1000 * 60 * 60 * 24; %>

<div hidden id="user-role" data-user-role="<%= userRole %>"></div>

<div class="row mt-3 mb-5">
	<% ['todo', 'in_progress', 'done'].forEach(status => { %>
	<div class="col-md-4">
		<h4 class="text-center">
			<% if (status === 'todo') { %>To Do<% } %> <% if (status ===
			'in_progress') { %>In Progress<% } %> <% if (status === 'done') {
			%>Done<% } %>
		</h4>
		<div class="task-column" id="<%= status %>" data-status="<%= status %>">
			<% tasks.filter(task => task.status === status).forEach(task => { %>
			<% const due = task.due_date ? new Date(task.due_date) : null; let
			dueClass = ''; let dueIcon = ''; const now = new Date(); const
			todayUTC = new Date(Date.UTC(now.getUTCFullYear(),
			now.getUTCMonth(), now.getUTCDate())).toISOString().slice(0, 10);
			const dueDateStr = due ? new Date(Date.UTC(due.getUTCFullYear(),
			due.getUTCMonth(), due.getUTCDate())).toISOString().slice(0, 10) :
			null; if (dueDateStr) { if (dueDateStr < todayUTC) { dueClass =
			'task-overdue'; dueIcon = 'â›”'; } else if (dueDateStr === todayUTC)
			{ dueClass = 'task-due-soon'; dueIcon = 'ðŸ”¥'; } } %>

			<div
				class="task-card <%= dueClass %>"
				data-task-id="<%= task.id %>"
			>
				<% if (dueIcon) { %>
				<span class="float-end fs-5"><%= dueIcon %></span>
				<% } %>

				<p
					><%= priority_colors[task.priority] %>
					<strong><%= task.name %></strong></p
				>
				<p class="text-muted">
					Assigned to: <%= task.username || 'Unassigned' %>
				</p>
				<p class="text-muted">
					Due: <%= task.due_date ? new
					Date(task.due_date).toLocaleDateString("en-US", { month:
					"short", day: "numeric", year: "numeric" }) : "No deadline"
					%>
				</p>

				<% if (userRole === 'editor' || userRole === 'owner') { %>
				<button
					class="btn btn-sm btn-warning edit-task-btn"
					data-bs-toggle="modal"
					data-bs-target="#editTaskModal"
					onclick="openEditTaskModal('<%= task.id %>', '<%= task.name %>', '<%= task.priority %>','<%= task.email %>', '<%= task.due_date %>')"
				>
					<i class="bi bi-pencil"></i>
					Edit
				</button>
				<button
					class="btn btn-sm btn-danger"
					onclick="openDeleteTaskModal('<%= task.id %>')"
				>
					<i class="bi bi-trash"></i>
					Delete
				</button>
				<% } %>
			</div>
			<% }); %>
		</div>
	</div>
	<% }); %>
</div>

<!-- Edit Task Modal -->
<%- include('./edit_task_modal') %>

<!-- Delete Task Modal -->
<%- include('./delete_task_modal') %>
